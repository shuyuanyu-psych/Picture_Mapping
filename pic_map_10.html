<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Picture Matching Experiment</title>

  <!-- jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" />

  <style>
    body { background: white; }
    .wrap { display:flex; justify-content:center; }
    img.stim {
      max-width: 95vw;
      max-height: 75vh;
      height: auto;
      width: auto;
    }
    .response-wrap {
      text-align: center;
      margin-top: 14px;
      font-size: 18px;
    }
    #respBox {
      font-size: 28px;
      width: 90px;
      text-align: center;
      padding: 6px 8px;
    }
    .hint { font-size: 14px; opacity: 0.75; margin-top: 6px; }
    button {
      margin-top: 10px;
      font-size: 18px;
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid #888;
      background: #f7f7f7;
    }
  </style>
</head>
<body></body>

<script>
/** ----------------------------
 * 1) AUTO-GENERATE 10 TRIALS
 * ----------------------------
 * Folder structure:
 *   index.html
 *   stimuli/
 *     pic1_1.jpg, pic1_3.png
 *     pic2_1.jpg, pic2_3.png
 *     ...
 *     pic10_1.jpg, pic10_3.png
 */
const N_TRIALS = 10;
const PREVIEW_MS = 500;

const origExt = {
  2: "png",
  9: "png"
  // everything else defaults to "jpg"
};

const stimFeatures = {
  "1": { Stimuli: "pic1",  Relational_Match_Response: "D", Object_Match_Response: "A" },
  "2": { Stimuli: "pic2",  Relational_Match_Response: "A", Object_Match_Response: "E" },
  "3": { Stimuli: "pic3",  Relational_Match_Response: "B", Object_Match_Response: "A" },
  "4": { Stimuli: "pic4",  Relational_Match_Response: "A", Object_Match_Response: "C" },
  "5": { Stimuli: "pic5",  Relational_Match_Response: "A", Object_Match_Response: "C" },
  "6": { Stimuli: "pic6",  Relational_Match_Response: "B", Object_Match_Response: "E" },
  "7": { Stimuli: "pic7",  Relational_Match_Response: "D", Object_Match_Response: "E" },
  "8": { Stimuli: "pic8",  Relational_Match_Response: "B", Object_Match_Response: "D" },
  "9": { Stimuli: "pic9",  Relational_Match_Response: "C", Object_Match_Response: "B" },
  "10": { Stimuli: "pic10", Relational_Match_Response: "E", Object_Match_Response: "A" }
};

const trials = Array.from({ length: N_TRIALS }, (_, i) => {
  const n = i + 1;
  const ext = origExt[n] || "jpg";
  return {
    trial_id: n,
    orig: `stimuli/pic${n}_1.${ext}`,
    highlight: `stimuli/pic${n}_3.png`,
    correct: "" // optional
  };
});

function imgHTML(src) {
  return `
    <div class="wrap">
      <img class="stim" src="${src}" />
    </div>
  `;
}

function getDeviceInfo() {
  const nav = navigator || {};
  const scr = screen || {};

  // Basic parsing from userAgent (good enough for logging)
  const ua = nav.userAgent || "";
  const isIPad = /iPad/.test(ua) || (nav.platform === "MacIntel" && nav.maxTouchPoints > 1);
  const isIPhone = /iPhone/.test(ua);
  const isAndroid = /Android/.test(ua);

  let device_type = "desktop";
  if (isIPad) device_type = "tablet";
  else if (isIPhone || isAndroid) device_type = "mobile";

  return {
    device_type,
    user_agent: ua,
    platform: nav.platform || "",
    language: nav.language || "",
    screen_w: scr.width || null,
    screen_h: scr.height || null,
    window_w: window.innerWidth || null,
    window_h: window.innerHeight || null,
    pixel_ratio: window.devicePixelRatio || null,
    touch_points: nav.maxTouchPoints || 0
  };
}


const timeline = [];
// Record device info for all trials
jsPsych = initJsPsych({}); // <-- move initJsPsych up here (see note below)
jsPsych.data.addProperties(getDeviceInfo());


/** Preload */
timeline.push({
  type: jsPsychPreload,
  images: trials.flatMap(t => [t.orig, t.highlight]),
});


// Participant ID screen (safe)
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="max-width: 600px; margin: 0 auto; font-size: 22px; text-align:center;">
      <p><strong>Participant ID</strong></p>
      <p>Please enter your participant ID and press Enter.</p>
      <input id="pidBox" type="text" autocomplete="off"
             style="font-size:28px; width:240px; text-align:center;" />
      <div class="hint" style="font-size:14px; opacity:.75; margin-top:8px;">
        (Press Enter to continue)
      </div>
    </div>
  `,
  choices: "NO_KEYS",
  on_load: () => {
    const box = document.getElementById("pidBox");
    box.focus();

    box.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        let pid = (box.value || "").trim();
        if (!pid) pid = "MISSING_ID";

        // attach to all future rows
        jsPsych.data.addProperties({ participant_id: pid });

        // end this screen and store pid on this row too
        jsPsych.finishTrial({ participant_id: pid });
      }
    });
  }
});


/** Instructions */
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="max-width: 900px; margin: 0 auto; font-size: 20px; line-height: 1.4;">
      <p>In this task, you will see pairs of pictures.</p>
      <p>First, you will have <strong>10 seconds</strong> to look at the pictures.</p>
      <p>Then one of the objects in the top picture will be highlighted.</p>
      <p>At this point, you should figure which object in the bottom picture it goes with. </p>
      <p><strong>Type the letter (A–E)</strong> that matches the highlighted object and press <strong>Enter</strong>
      (or tap <strong>OK</strong>).</p>
      <p class="hint"> Click Next to begin.</p>

      <div style="text-align:center; margin-top: 16px;">
        <button id="nextBtn" type="button" style="font-size:20px; padding:12px 18px;">
          Next
        </button>
      </div>

    </div>
  `,
  choices: [" "],

  on_load: () => {
    document.getElementById("nextBtn").addEventListener("click", () => {
      jsPsych.finishTrial({ advanced_by: "next_button" });
    });
  }
});

/** Trials */
trials.forEach((t) => {

  // Phase 1: original image (10s)
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: imgHTML(t.orig),
    choices: "NO_KEYS",
    trial_duration: PREVIEW_MS,
    data: {phase: "preview", trial_id: t.trial_id, orig: t.orig, highlight: t.highlight}
  });

  
  // Phase 2: highlighted/options + response on same screen (records RT)
  timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      ${imgHTML(t.highlight)}
      <div class="response-wrap">
      <div><strong>Type your answer (A–E) that goes with the highlighted object</strong>:</div>
      <input id="respBox" type="text" maxlength="1" autocomplete="off" inputmode="text" />
      <div class="hint">Only A, B, C, D, E are accepted.</div>
      <button id="okBtn" type="button">OK</button>
      </div>
    `,
    choices: "NO_KEYS",   // we handle Enter ourselves
    data: { phase: "response", trial_id: t.trial_id, orig: t.orig, highlight: t.highlight, correct: t.correct || "" },

    on_load: () => {
      const box = document.getElementById("respBox");
      const ok = document.getElementById("okBtn");

      box.focus();

      // RT starts exactly when highlight screen appears
      const startTime = performance.now();

      // Restrict input to A–E, uppercase, single char
      box.addEventListener("input", () => {
        let v = (box.value || "").toUpperCase();
        v = v.replace(/[^A-E]/g, "");
        box.value = v.slice(0, 1);
    });

      const submit = (method) => {
      const resp = (box.value || "").trim().toUpperCase();
      const isValid = ["A","B","C","D","E"].includes(resp);

      if (!isValid) {
        // Don’t proceed
        box.focus();
        box.style.border = "2px solid #cc0000";

        // Optional: show/update an error message
        let err = document.getElementById("errMsg");
        if (!err) {
          err = document.createElement("div");
          err.id = "errMsg";
          err.style.marginTop = "8px";
          err.style.fontSize = "16px";
          err.style.color = "#cc0000";
          err.textContent = "Please enter A, B, C, D, or E before continuing.";
          document.querySelector(".response-wrap").appendChild(err);
    }
    return;
  }

  // valid → proceed and record RT
  const rt = Math.round(performance.now() - startTime);
  const f = stimFeatures[String(t.trial_id)] || {};

  let response_score = 3; // default = other
  if (resp === f.Relational_Match_Response) {
    response_score = 1;
  } else if (resp === f.Object_Match_Response) {
    response_score = 2;
  }

  jsPsych.finishTrial({
    phase: "response",
    ID: jsPsych.data.get().values()[0]?.participant_id || "MISSING_ID",
    TrialID: t.trial_id,
    stimuli: t.highlight,
    Sti: f.Stimuli || "",
    Relational_Match_Response: f.Relational_Match_Response || "",
    Object_Match_Response: f.Object_Match_Response || "",
    response: resp,
    response_score: response_score,
    RT: rt,
    submit_method: method
  });
};
  
  box.addEventListener("input", () => {
    box.style.border = "";              // clear error border when they type
    const err = document.getElementById("errMsg");
    if (err) err.remove();              // remove error message
});
    // Enter submits
    box.addEventListener("keydown", (e) => {
      if (e.key === "Enter") submit("enter");
    });

    // OK submits
    ok.addEventListener("click", () => submit("tap_ok"));
  },

  on_finish: (data) => {
    if (data.correct) {
      data.is_correct = (String(data.choice).toUpperCase() === String(data.correct).toUpperCase()) ? 1 : 0;
    }
  }
});
});

/** End + AUTO CSV download */
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div style="text-align:center; font-size: 22px;">
      <p>Done! Thank you.</p>
      <p class="hint">Your data will download automatically.</p>
    </div>
  `,
  choices: "NO_KEYS",
  trial_duration: 500, // short pause so the message is visible
  on_finish: () => {
    const rows = jsPsych.data.get().filter({ phase: "response" }).values();

    const header = ["ID","TrialID","stimuli","Sti","Relational_Match_Response","Object_Match_Response",
    "response","response_score","RT","device_type","platform","screen_w","screen_h","window_w","window_h","pixel_ratio","touch_points"
    ];
    const escapeCSV = (v) => {
      const s = (v === null || v === undefined) ? "" : String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
};

    const csv =
    header.join(",") + "\n" +
    rows.map(r => header.map(h => escapeCSV(r[h])).join(",")).join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

        // ---- participant ID: force S### format ----
    const pidRaw = jsPsych.data.get().values()[0]?.participant_id || "1";
    const pidNum = String(pidRaw).replace(/\D/g, "");   // keep digits only
    const pidPadded = pidNum.padStart(3, "0");
    const pid = `S${pidPadded}`;

    // ---- local timestamp: YYYYMMDD_HHMMSS ----
    const d = new Date();
    const ts =
      d.getFullYear().toString() +
      String(d.getMonth() + 1).padStart(2, "0") +
      String(d.getDate()).padStart(2, "0") + "_" +
      String(d.getHours()).padStart(2, "0") +
      String(d.getMinutes()).padStart(2, "0") +
      String(d.getSeconds()).padStart(2, "0");

    // ---- filename ----
    const filename = `PicMap_${pid}_${ts}.csv`;

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();

    setTimeout(() => URL.revokeObjectURL(url), 5000);
  }
});


jsPsych.run(timeline);
</script>
</html>